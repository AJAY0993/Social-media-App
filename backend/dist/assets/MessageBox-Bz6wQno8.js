import{v as u,j as e,g as b,f as k,_ as M,p as B,a as C,a3 as j,N as x,a1 as U,u as S,Z as N,B as v,a4 as I,a5 as O,a6 as P,O as R,o as A,a7 as D,U as E,a8 as F}from"./index-BzvtiaCt.js";import{u as q}from"./useBack-B-vAR0Tn.js";import{u as H}from"./useProfile-BN7lu4PZ.js";const L="_message_xjn6k_1",T="_sent_xjn6k_19",$="_recieved_xjn6k_43",h={message:L,sent:T,recieved:$},w=u.forwardRef(function({showImg:s=!1,message:a},t){const o=!!a.sent;return e.jsxs("div",{className:h.message__container+" "+(o?h.sent:h.recieved),ref:t,children:[s&&e.jsx("img",{className:"btn--circle",src:"https://i.ibb.co/mBXRT6g/profile-user.png",alt:"profile-user",border:"0"}),e.jsx("p",{className:h.message,children:a.message||"Lorem ipsum, dolor sit amet consectetur adipisicing elit. Laudantium,magni."})]})});function G(){const[s,a]=u.useState(),{recieverId:t}=b();async function o(n){try{a(!0);const l=(await k("messages",{method:"POST",data:{recieverId:t,message:n}})).data.data.message;return a(!1),l}catch(i){M.error(i.response.data.message),a(!1)}}return{sendMessage:o,isSending:s}}const V="_messageBox_8a5pb_1",z="_header_8a5pb_13",K="_back__btn_wrapper_8a5pb_29",Q="_user_8a5pb_39",X="_secondaryHeader_8a5pb_55",Z="_btn__wrapper_8a5pb_67",J="_messages__container_8a5pb_75",W="_form__container_8a5pb_91",Y="_form_8a5pb_91",r={messageBox:V,header:z,back__btn_wrapper:K,user:Q,secondaryHeader:X,btn__wrapper:Z,messages__container:J,form__container:W,form:Y};function ee(){const{recieverId:s}=b(),{data:a,isFetchingMessages:t}=B({queryFn:async()=>{try{return(await k(`conversations/to?reciever=${s}`)).data.data.messages}catch{return[]}},queryKey:[`messages:${s}`]});return{messages:a,isFetchingMessages:t}}const se=navigator.mediaDevices.getUserMedia||navigator.mediaDevices.webkitGetUserMedia||navigator.mediaDevices.mozGetUserMedia;function ae({userId:s}){const a=C(),{setRemoteStream:t,socket:o}=j(),n=x(U),i=S(),{peer:l,peers:c}=j(),g=x(N).includes(s),y=async()=>{if(!g)return M.error("User is offline can not call right now");try{const p=await se({video:!0,audio:!0}),d=l.call(c[s],p);console.log("Peer Id:",c[s]),a(O(d)),i("/call"),d.on("stream",function(f){t(f)}),d.on("close",()=>{alert("Call finished"),a(P()),p.getTracks().forEach(function(f){f.stop()}),i("/")})}catch(p){console.log(p)}};return e.jsx(v,{type:"primary",variation:"square",onClick:y,disabled:n,children:e.jsx(I,{})})}function ce(){const s=u.useRef(),a=S(),{recieverId:t}=b(),o=x(N)||[],{profile:n,isProfileLoading:i}=H(),[l,c]=u.useState([]),_=x(R),g=q(),p=o.includes(t)?"online":"offline",{messages:d,isFetchingMessages:f}=ee();return u.useEffect(()=>{setTimeout(()=>{var m;return(m=s.current)==null?void 0:m.scrollIntoView({behavior:"smooth"})},500)},[l]),f||i?e.jsx(A,{}):e.jsxs("section",{className:r.messageBox,children:[e.jsxs("div",{className:r.header,children:[e.jsx("div",{className:r.back__btn_wrapper,children:e.jsx(v,{type:"primary",variation:"square",onClick:g,children:e.jsx(D,{})})}),e.jsx(E,{showBtn:!1,customClass:r.user,user:n,secondaryCaption:p,children:e.jsx(ae,{userId:n._id})})]}),e.jsxs("div",{className:r.box,children:[e.jsxs("article",{className:r.secondaryHeader+" flex",children:[e.jsx("h3",{children:n.username}),e.jsx("div",{className:r.btn__wrapper,children:e.jsx(v,{type:"primary",variation:"rounded",onClick:()=>a(`/profile/${n._id}`),children:"Profile"})})]}),e.jsx("div",{className:r.messages__container+" flex",children:d==null?void 0:d.map(m=>e.jsx(w,{ref:s,message:{...m,sent:m.sender===_}},Math.random()))}),e.jsx("div",{className:r.messages__container+" flex",children:l.map(m=>e.jsx(w,{message:m,ref:s},Math.random()))}),e.jsx(ne,{setMessages:c})]})]})}function ne({setMessages:s}){const[a,t]=u.useState(""),{sendMessage:o}=G(),{socket:n}=j(),i=new Audio("/audio/sent.mp3"),l=c=>{c.preventDefault(),s(_=>[..._,{message:a,sent:!0}]),o(a),t(""),i.play()};return u.useEffect(()=>{const c=new Audio("/audio/notif.mp3");return n.on("event:message",_=>{s(g=>[...g,_]),c.play()}),()=>n.off("event:message")},[s,n]),e.jsx("footer",{className:r.form__container,children:e.jsxs("form",{className:"flex "+r.form,action:"",onSubmit:l,children:[e.jsx("input",{className:"inp inp__secondary",type:"text",value:a,onChange:c=>t(c.target.value)}),e.jsx(v,{type:"primary",variation:"rounded",width:"fit",children:e.jsx(F,{})})]})})}export{ce as default};
